### 如何在消息队列的收发两端优化系统性能，提前预防消息积压

对于绝大多数使用消息队列的业务来说，消息队列本身的处理能力要远大于业务系统的处理能力，对于消息队列的性能优化，我们更关注的是，在消息的收发两端，我们的业务代码怎么和消息队列配合，达到一个最佳的性能。

在业务比较在意延迟的时候，批量发送必然会产生延迟。这种情况下就可以通过并发提升性能。或者减少每次批量的大小。

如果是离线任务，更加注重业务的吞吐量，这时候就可以批量发送。

> 有涉及到了 性能评价指标。qps ，tps。 请求延时和吞吐量。

#### 生产端
增加批量或者是增加并发

#### 消费端
在消费端需要注意的是，增加并发需要同步扩容分区数量，否则是起不到效果的。

1. 消费处理的一个常见的错误。把消息放到一个内存队列里，启动多个线程去队列里拿消息。这个错误是如果内存节点宕机，那么就会出现丢消息的问题。

### 当系统发生消息积压了之后，该如何处理

在系统设计的时候。一定要保证消费端的消费性能要高于生产端的发送性能，这样的系统才能健康的持续运行。

导致积压突然增加，最粗粒度的原因，只有两种：要么是发送变快了，要么是消费变慢了。

如果单位时间内发送消息增多，可以1 扩容消费端，2 如果没有更多的资源可以进行服务降级，保证主要业务进行。减少一些不重要的业务数据的发送。